<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Pok√©bowl</title>
  <style>
    /* Ton CSS ici (inchang√© car d√©j√† optimis√©) */
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: #fefefe;
      margin: 0;
      padding: 3em;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #ff3a3a;
      font-size: 2.5em;
      letter-spacing: 1px;
      margin-bottom: 1em;
    }
    #commandeTable {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
  padding: 0;
  list-style: none;
}

.commande-card {
  width: 300px;
  background: #ffffff;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  border-radius: 12px;
  padding: 1.2em;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  font-size: 0.9em;
  border: 1px solid #f0f0f0;
}

.commande-card h2 {
  text-align: center;
  margin: 0 0 0.5em 0;
  font-size: 1.3em;
  color: #ff3a3a;
}

.commande-card .info {
  margin-bottom: 0.5em;
  border-bottom: 1px dashed #ddd;
  padding-bottom: 0.5em;
}

.commande-card .label {
  font-weight: bold;
  display: inline-block;
  min-width: 80px;
}

.commande-card .ingredient-container {
  width: 70px;
  height: 90px;
  margin: 5px;
}

.commande-card .ingredients-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 6px;
  margin: 8px 0;
}

.commande-card button {
  align-self: center;
  margin-top: 1em;
}

    button {
      background-color: #10b981;
      color: white;
      padding: 0.6em 1.2em;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    button:hover {
      background-color: #0f9b72;
      transform: scale(1.03);
    }
    button:active {
      transform: scale(0.98);
    }
    .ligne-base {
  display: flex;
  align-items: center;
  gap: 16px;
}


    .ingredient-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #fdfdfd;
      border-radius: 10px;
      padding: 10px;
      margin: 5px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      width: 80px;
      height: 100px;
      box-sizing: border-box;
      transition: transform 0.2s ease;
    }
    .ingredient-container:hover {
      transform: translateY(-3px);
    }
    .ingredient-img {
      width: 42px;
      height: 42px;
      object-fit: contain;
      margin-bottom: 6px;
    }
    @media (max-width: 900px) {
      body {
        padding: 1em;
      }
      table, th, td {
        font-size: 0.85em;
      }
      .ingredient-container {
        width: 60px;
        height: 80px;
      }
      h1 {
        font-size: 2em;
      }
    }
  </style>
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
  <h1>Tableau de commandes Pok√©bowl</h1>

  <div id="commandeTable"></div>
  </table>

  <script>
  // URLs
  const DATA_URL = "/.netlify/functions/proxy";
  const VALIDATION_URL = "https://script.google.com/macros/s/AKfycbzO1YE54lzfF8iZmndAbAxrZILs3V5zkGJt11_dkkJK6ZLd8uAAfpUG0hjMTLXVuIw/exec";

  // Helpers
  const imgFromLabel = (label) =>
    `./images/${(label || '').toLowerCase().replace(/\s+/g,'_')}.png`;

  const isValidated = v => (String(v || '').trim().toLowerCase() === 'v');

  // Cl√© de regroupement d‚Äôune commande
  function groupKey(row) {
    // Horodatage tel qu‚Äôil ressort de la Sheet + identit√© client
    return [row["Horodatage"], row["Nom"], row["T√©l√©phone"]].join("||");
  }

  // Regroupe lignes par commande + conserve les rowNumbers (index+2)
  function groupRows(rows) {
    const groups = new Map();
    rows.forEach((row, i) => {
      const key = groupKey(row);
      const rowNumber = i + 2; // 1=header, donc +2
      if (!groups.has(key)) {
        groups.set(key, { meta: row, rows: [], rowNumbers: [], allValidated: true });
      }
      const g = groups.get(key);
      g.rows.push(row);
      g.rowNumbers.push(rowNumber);
      if (!isValidated(row["Valid√©e"])) g.allValidated = false;
    });
    return Array.from(groups.values());
  }

  // Composant visuel d‚Äôun ‚Äúbloc ingr√©dient‚Äù (image + label)
  function ingredientBlock(label) {
    if (!label) return '';
    return `
      <div class="ingredient-container">
        <img class="ingredient-img" src="${imgFromLabel(label)}" alt="${label}">
        <div style="font-size:.7em">${label}</div>
      </div>
    `;
  }

  // Rend un item POK√â / MENU
  function renderPokeOrMenu(row) {
    const titre = row["Type"] === 'menu'
      ? `Menu Pok√© ${row["Taille"] || ''} + Smoothie`
      : `Pok√© ${row["Taille"] || ''}`;

    const ingredients = (row["Ingr√©dients"] || "")
      .split(",").map(s => s.trim()).filter(Boolean).slice(0, 12);

    const toppings = (row["Toppings"] || "")
      .split(",").map(s => s.trim()).filter(Boolean);

    return `
      <div class="info">
        <div style="font-weight:700;margin-bottom:.3em;">${titre}</div>

        <div class="ligne-base">
          <span class="label">üßæ Base :</span>
          ${row["Base"] ? ingredientBlock(row["Base"]) : '‚Äî'}
        </div>

        <div class="label" style="margin-top:.4em">ü•ó Ingr√©dients :</div>
        <div class="ingredients-grid">
          ${ingredients.map(ingredientBlock).join('') || '‚Äî'}
        </div>

        <div class="ligne-base">
          <span class="label">üçó Prot√©ine(s) :</span>
          ${row["Prot√©ines"]
            ? row["Prot√©ines"].split(",").map(s => s.trim()).filter(Boolean).map(ingredientBlock).join('')
            : '‚Äî'}
        </div>

        <div class="ligne-base">
          <span class="label">ü•¢ Sauce :</span>
          ${row["Sauce"] ? ingredientBlock(row["Sauce"]) : '‚Äî'}
        </div>

        <div class="label" style="margin-top:.4em">üå± Toppings :</div>
        <div class="ingredients-grid">
          ${toppings.length ? toppings.map(ingredientBlock).join('') : '‚Äî'}
        </div>

        ${row["Type"] === 'menu' && row["Smoothie"]
          ? `<div class="ligne-base"><span class="label">ü•£ Smoothie :</span> ${ingredientBlock(row["Smoothie"])}</div>`
          : ''}
      </div>
    `;
  }

  // Rend un item SIMPLE (cookie, boisson, jus, smoothie bowl, etc.)
  function renderSimpleItem(row) {
    const type = row["Type"] || 'article';
    const article = row["Article"] || type;
    const qty = row["Quantit√©"] || 1;
    const sousTotal = row["Sous-total"] ? `${row["Sous-total"]} ‚Ç¨` : '‚Äî';
    return `
      <div class="info">
        <div><b>${article}</b> &times; ${qty}</div>
        <div class="tiny" style="opacity:.8">Sous-total : ${sousTotal}</div>
      </div>
    `;
  }

  // Valide toutes les lignes d‚Äôun groupe (commande)
  async function validerCommandeGroup(rowNumbers) {
    try {
      const calls = rowNumbers.map(rn =>
        fetch(`${VALIDATION_URL}?action=valider&row=${rn}`).then(res => res.text())
      );
      const results = await Promise.all(calls);
      const ok = results.every(t => String(t).trim().toLowerCase() === 'ok');
      if (!ok) {
        alert("Une ou plusieurs lignes n'ont pas pu √™tre valid√©es.");
      }
      await fetchCommandes(); // refresh
    } catch (e) {
      console.error(e);
      alert("Erreur r√©seau lors de la validation.");
    }
  }

  // Rendu d‚Äôune commande (groupe)
  function renderCommandeCard(group) {
    const c = group.meta;
    const container = document.getElementById("commandeTable");

    const card = document.createElement("div");
    card.className = "commande-card";

    // Titre (client + ID compact)
    const h2 = document.createElement("h2");
    const t = new Date(c["Horodatage"]);
    const id = isNaN(t.getTime())
      ? "#" + Math.floor(100000 + Math.random() * 900000)
      : `#${String(t.getHours()).padStart(2,'0')}${String(t.getMinutes()).padStart(2,'0')}${String(t.getSeconds()).padStart(2,'0')}`;
    h2.textContent = `${c["Nom"] || ""} ${id}`;
    card.appendChild(h2);

    // Locker
    const locker = document.createElement("div");
    locker.className = "info";
    locker.innerHTML = `<span class="label">üì¶ Locker :</span> ${c["Locker"] || "‚Äì"}`;
    card.appendChild(locker);

    // Tel
    const tel = document.createElement("div");
    tel.className = "info";
    tel.innerHTML = `<span class="label">üìû T√©l√©phone :</span> ${c["T√©l√©phone"] || ""}`;
    card.appendChild(tel);

    // Horaire
    const horaire = document.createElement("div");
    horaire.className = "info";
    horaire.innerHTML = `<span class="label">üïí Horaire :</span> <strong>${c["Horaire"] || ""}</strong>`;
    card.appendChild(horaire);

    // Liste des items de la commande
    const pokeRows = group.rows.filter(r => (r["Type"] === 'poke' || r["Type"] === 'menu'));
    const simpleRows = group.rows.filter(r => !(r["Type"] === 'poke' || r["Type"] === 'menu'));

    // Pok√© / Menu
    pokeRows.forEach(r => {
      const block = document.createElement("div");
      block.innerHTML = renderPokeOrMenu(r);
      card.appendChild(block);
    });

    // Articles simples
    if (simpleRows.length) {
      const lab = document.createElement("div");
      lab.className = "label";
      lab.textContent = "üßÅ Articles compl√©mentaires :";
      card.appendChild(lab);

      simpleRows.forEach(r => {
        const block = document.createElement("div");
        block.innerHTML = renderSimpleItem(r);
        card.appendChild(block);
      });
    }

    // Remarques (Commentaires)
    if (c["Commentaires"]) {
      const rem = document.createElement("div");
      rem.className = "info";
      rem.innerHTML = `<span class="label">üìù Remarques :</span> ${c["Commentaires"]}`;
      card.appendChild(rem);
    }

    // Total + bouton
    const bottom = document.createElement("div");
    bottom.style.display = "flex";
    bottom.style.alignItems = "center";
    bottom.style.justifyContent = "space-between";
    bottom.style.marginTop = "0.6em";

    const totalDiv = document.createElement("div");
    totalDiv.innerHTML = `<span class="label">üí∂ Total :</span> <b>${c["Total"] || "‚Äî"}</b>`;
    bottom.appendChild(totalDiv);

    const btn = document.createElement("button");
    btn.textContent = group.allValidated ? "‚úÖ D√©j√† valid√©e" : "Commande pr√™te";
    btn.disabled = group.allValidated;
    btn.onclick = () => validerCommandeGroup(group.rowNumbers);
    bottom.appendChild(btn);

    card.appendChild(bottom);
    container.appendChild(card);
  }

  // Fetch + render
  async function fetchCommandes() {
    try {
      const res = await fetch(DATA_URL);
      const data = await res.json(); // tableau brut des lignes
      const container = document.getElementById("commandeTable");
      container.innerHTML = "";

      // Filtrer les lignes non valid√©es OU les grouper puis afficher (on affiche seulement les commandes ayant au moins une ligne non valid√©e)
      const groups = groupRows(data);
      const pending = groups.filter(g => !g.allValidated);

      if (!pending.length) {
        container.innerHTML = "<p>Aucune commande en attente ‚úÖ</p>";
        return;
      }

      pending.forEach(renderCommandeCard);
    } catch (err) {
      console.error("Erreur fetchCommandes :", err);
      alert("Erreur lors du chargement des commandes.");
    }
  }

  document.addEventListener("DOMContentLoaded", fetchCommandes);
</script>

</body>
</html>

