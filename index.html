<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Pok√©bowl</title>
  <style>
    body{font-family:'Segoe UI',Roboto,sans-serif;background:#fefefe;margin:0;padding:3em;color:#333}
    h1{text-align:center;color:#ff3a3a;font-size:2.5em;letter-spacing:1px;margin:0 0 .6em}
    #commandeTable{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;padding:0;list-style:none}

    /* Toolbar */
    .toolbar{
      max-width:1100px;margin:0 auto 1rem;display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center
    }
    .tb-btn{
      background:#fff;border:1px solid #eee;border-radius:999px;padding:.55rem .9rem;cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.05);font-weight:600
    }
    .tb-btn.primary{background:#10b981;color:#fff;border-color:#10b981}
    .tb-btn.warn{background:#ff3a3a;color:#fff;border-color:#ff3a3a}

    .commande-card{width:320px;background:#fff;box-shadow:0 4px 15px rgba(0,0,0,.08);border-radius:12px;padding:1.2em;font-size:.9em;border:1px solid #f0f0f0;display:flex;flex-direction:column}
    .commande-card h2{text-align:center;margin:.1em 0 .5em;font-size:1.2em;color:#ff3a3a}
    .info{margin-bottom:.5em;border-bottom:1px dashed #ddd;padding-bottom:.5em}
    .label{font-weight:700;display:inline-block;min-width:90px}
    .tiny{font-size:.85em;opacity:.75}

    .ingredient-container{width:70px;height:92px;margin:5px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fdfdfd;border-radius:10px;padding:8px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
    .ingredient-img{width:42px;height:42px;object-fit:contain;margin-bottom:6px}
    .ingredients-grid{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin:8px 0}
    .ligne-base{display:flex;align-items:center;gap:12px}

    /* Footer actions sur carte */
    .card-actions{display:flex;gap:.5rem;justify-content:space-between;align-items:center;margin-top:.6rem}
    .btn{background:#10b981;color:#fff;border:none;border-radius:10px;padding:.5rem .8rem;cursor:pointer;box-shadow:0 3px 10px rgba(16,185,129,.2);font-weight:600}
    .btn.secondary{background:#fff;color:#333;border:1px solid #eee}
    .btn.warn{background:#ff3a3a}

    @media (max-width: 900px){
      body{padding:1em}
      .ingredient-container{width:60px;height:80px}
      h1{font-size:2em}
      .commande-card{width:100%}
    }
  </style>
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
  <h1>Tableau de commandes Pok√©bowl</h1>

  <!-- Barre d‚Äôactions -->
  <div class="toolbar">
    <button class="tb-btn" id="btnRefresh">üîÑ Rafra√Æchir</button>
    <button class="tb-btn" id="btnToggleValidated">üëÅÔ∏è Afficher commandes valid√©es</button>
    <button class="tb-btn primary" id="btnValidateAll">‚úÖ Tout valider (affich√©es)</button>
    <button class="tb-btn" id="btnPrint">üñ®Ô∏è Imprimer la liste</button>
  </div>

  <div id="commandeTable"></div>

  <script>
    // URLs
    const DATA_URL = "/.netlify/functions/proxy"; // via Netlify -> Apps Script doGet
    const VALIDATION_URL = "https://script.google.com/macros/s/AKfycbzO1YE54lzfF8iZmndAbAxrZILs3V5zkGJt11_dkkJK6ZLd8uAAfpUG0hjMTLXVuIw/exec";

    // State
    let SHOW_VALIDATED = false; // par d√©faut on affiche seulement les commandes non valid√©es
    let LAST_GROUPS = [];       // cache des groupes pour actions globales

    // Helpers
    const isValidated = v => (String(v || '').trim().toLowerCase() === 'v');
    const imgFromLabel = (label) => `./images/${(label || '').toLowerCase().replace(/[^\w\s-]/g,'').replace(/\s+/g,'_')}.png`;

    function groupKey(row){
      // Cl√© de regroupement : Horodatage + Nom + T√©l√©phone
      return [row["Horodatage"], row["Nom"], row["T√©l√©phone"]].join("||");
    }

    function groupRows(rows){
      const groups = new Map();
      rows.forEach((row, i) => {
        const key = groupKey(row);
        const rowNumber = i + 2; // 1 = en-t√™tes
        if(!groups.has(key)){
          groups.set(key, { meta: row, rows: [], rowNumbers: [], allValidated: true });
        }
        const g = groups.get(key);
        g.rows.push(row);
        g.rowNumbers.push(rowNumber);
        if(!isValidated(row["Valid√©e"])) g.allValidated = false;
      });
      return Array.from(groups.values());
    }

    function ingredientBlock(label){
      if(!label) return '';
      return `
        <div class="ingredient-container">
          <img class="ingredient-img" src="${imgFromLabel(label)}" alt="${label}" onerror="this.style.opacity=.2">
          <div style="font-size:.7em;text-align:center">${label}</div>
        </div>
      `;
    }

    // Affichage complet POK√â / MENU
    function renderPokeOrMenu(row){
      const titre = row["Type"] === 'menu'
        ? `Menu Pok√© ${row["Taille"] || ''} + Smoothie`
        : `Pok√© ${row["Taille"] || ''}`;

      const ingredients = (row["Ingr√©dients"] || "").split(",").map(s=>s.trim()).filter(Boolean);
      const toppings    = (row["Toppings"] || "").split(",").map(s=>s.trim()).filter(Boolean);
      const proteines   = (row["Prot√©ines"] || "").split(",").map(s=>s.trim()).filter(Boolean);

      const qty = row["Quantit√©"] || 1;
      const prix = row["Prix"] ? `${row["Prix"]} ‚Ç¨` : '‚Äî';
      const sousTotal = row["Sous-total"] ? `${row["Sous-total"]} ‚Ç¨` : '‚Äî';

      return `
        <div class="info">
          <div style="font-weight:700;margin-bottom:.3em;">${titre}</div>

          <div class="tiny">Type: <b>${row["Type"]}</b> ‚Ä¢ Article: <b>${row["Article"]||titre}</b> ‚Ä¢ Qt√©: <b>${qty}</b> ‚Ä¢ PU: <b>${prix}</b> ‚Ä¢ Sous-total: <b>${sousTotal}</b></div>

          <div class="ligne-base" style="margin-top:.35em">
            <span class="label">üßæ Base :</span>
            ${row["Base"] ? ingredientBlock(row["Base"]) : '‚Äî'}
          </div>

          <div class="label" style="margin-top:.4em">ü•ó Ingr√©dients :</div>
          <div class="ingredients-grid">
            ${ingredients.length ? ingredients.map(ingredientBlock).join('') : '‚Äî'}
          </div>

          <div class="ligne-base">
            <span class="label">üçó Prot√©ine(s) :</span>
            ${proteines.length ? proteines.map(ingredientBlock).join('') : '‚Äî'}
          </div>

          <div class="ligne-base">
            <span class="label">ü•¢ Sauce :</span>
            ${row["Sauce"] ? ingredientBlock(row["Sauce"]) : '‚Äî'}
          </div>

          <div class="label" style="margin-top:.4em">üå± Toppings :</div>
          <div class="ingredients-grid">
            ${toppings.length ? toppings.map(ingredientBlock).join('') : '‚Äî'}
          </div>

          ${row["Type"] === 'menu' && row["Smoothie"]
            ? `<div class="ligne-base"><span class="label">ü•£ Smoothie :</span> ${ingredientBlock(row["Smoothie"])}</div>`
            : ''}
        </div>
      `;
    }

    // Affichage complet ARTICLE SIMPLE
    function renderSimpleItem(row) {
  const article = row["Article"] || row["Type"] || "Article";
  const qty = row["Quantit√©"] || 1;
  const sousTotal = row["Sous-total"] ? `${row["Sous-total"]} ‚Ç¨` : '‚Äî';
  
  const imgName = article.toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9_]/g,''); 
  // ex: "Smoothie Bowl Mangue" ‚Üí "smoothiebowlmangue" (donc fichier = smoothiebowlmangue.png)

  return `
    <div class="info ligne-base">
      <div class="ingredient-container">
        <img class="ingredient-img" src="./images/${imgName}.png" alt="${article}">
        <div style="font-size:.7em">${article}</div>
      </div>
      <div style="margin-left:8px;">
        Qt√©: ${qty} <br>
        <span style="opacity:.8">Sous-total : ${sousTotal}</span>
      </div>
    </div>
  `;
}


    async function validerCommandeGroup(rowNumbers){
      try{
        const calls = rowNumbers.map(rn => fetch(`${VALIDATION_URL}?action=valider&row=${rn}`).then(r=>r.text()));
        const results = await Promise.all(calls);
        const ok = results.every(t => String(t).trim().toLowerCase() === 'ok');
        if(!ok) alert("Une ou plusieurs lignes n'ont pas pu √™tre valid√©es.");
        await fetchCommandes();
      }catch(e){
        console.error(e); alert("Erreur r√©seau lors de la validation.");
      }
    }

    function telHref(phone){
      const digits = String(phone||'').replace(/[^\d+]/g,'');
      return digits ? `tel:${digits}` : null;
    }

    function renderCommandeCard(group){
      const c = group.meta;
      const container = document.getElementById("commandeTable");

      const card = document.createElement("div");
      card.className = "commande-card";

      // Titre (Nom + ID compact + Horodatage)
      const h2 = document.createElement("h2");
      const t = new Date(c["Horodatage"]);
      const id = isNaN(t.getTime())
        ? "#" + Math.floor(100000 + Math.random()*900000)
        : `#${String(t.getHours()).padStart(2,'0')}${String(t.getMinutes()).padStart(2,'0')}`;
      h2.textContent = `${c["Nom"] || ""} ${id}`;
      card.appendChild(h2);

      // Horodatage brut
      const dt = document.createElement("div");
      dt.className = "info tiny";
      dt.innerHTML = `<span class="label">üóìÔ∏è Cr√©√©e :</span> ${c["Horodatage"] || "‚Äî"}`;
      card.appendChild(dt);

      // Locker / Tel / Horaire
      const locker = document.createElement("div");
      locker.className = "info";
      locker.innerHTML = `<span class="label">üì¶ Locker :</span> ${c["Locker"] || "‚Äì"}`;
      card.appendChild(locker);

      const tel = document.createElement("div");
      tel.className = "info";
      tel.innerHTML = `<span class="label">üìû T√©l√©phone :</span> ${c["T√©l√©phone"] || ""}`;
      card.appendChild(tel);

      const horaire = document.createElement("div");
      horaire.className = "info";
     function formatHoraire(h) {
  if (!h) return "";
  // si d√©j√† HH:MM
  if (/^\d{1,2}:\d{2}$/.test(h)) return h;
  // si string ISO
  const d = new Date(h);
  if (!isNaN(d)) {
    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  return h;
}

horaire.innerHTML = `<span class="label">üïí Horaire :</span> <strong>${formatHoraire(c["Horaire"])}</strong>`;

      card.appendChild(horaire);

      // D√©tailler tous les items
      const pokeRows = group.rows.filter(r => (r["Type"] === 'poke' || r["Type"] === 'menu'));
      const simpleRows = group.rows.filter(r => !(r["Type"] === 'poke' || r["Type"] === 'menu'));

      pokeRows.forEach(r => {
        const block = document.createElement("div");
        block.innerHTML = renderPokeOrMenu(r);
        card.appendChild(block);
      });

      if(simpleRows.length){
        const lab = document.createElement("div");
        lab.className = "label";
        lab.textContent = "üßÅ Articles compl√©mentaires :";
        card.appendChild(lab);
        simpleRows.forEach(r => {
          const block = document.createElement("div");
          block.innerHTML = renderSimpleItem(r);
          card.appendChild(block);
        });
      }

      // Remarques
      if (c["Commentaires"]) {
        const rem = document.createElement("div");
        rem.className = "info";
        rem.innerHTML = `<span class="label">üìù Remarques :</span> ${c["Commentaires"]}`;
        card.appendChild(rem);
      }

      // Total + boutons
      const footer = document.createElement("div");
      footer.className = "card-actions";

      const totalDiv = document.createElement("div");
      totalDiv.innerHTML = `<span class="label">üí∂ Total :</span> <b>${c["Total"] || "‚Äî"}</b>`;
      footer.appendChild(totalDiv);

      const btns = document.createElement("div");
      btns.style.display = "flex"; btns.style.gap = ".4rem";

      // Appeler
      const callHref = telHref(c["T√©l√©phone"]);
      const bCall = document.createElement("button");
      bCall.className = "btn secondary";
      bCall.textContent = "üì≤ Appeler";
      if(callHref){ bCall.onclick = ()=> window.location.href = callHref; } else { bCall.disabled = true; }
      btns.appendChild(bCall);

      // Imprimer la carte
      const bPrint = document.createElement("button");
      bPrint.className = "btn secondary";
      bPrint.textContent = "üñ®Ô∏è Imprimer";
      bPrint.onclick = ()=> {
        const w = window.open('', '_blank');
        w.document.write(`<html><head><title>${c["Nom"]||"Commande"}</title></head><body>${card.outerHTML}</body></html>`);
        w.document.close(); w.focus(); w.print(); w.close();
      };
      btns.appendChild(bPrint);

      // Valider
      const bOk = document.createElement("button");
      bOk.className = "btn warn";
      bOk.textContent = group.allValidated ? "‚úÖ D√©j√† valid√©e" : "Commande pr√™te";
      bOk.disabled = group.allValidated;
      bOk.onclick = ()=> validerCommandeGroup(group.rowNumbers);
      btns.appendChild(bOk);

      footer.appendChild(btns);
      card.appendChild(footer);

      document.getElementById("commandeTable").appendChild(card);
    }

    async function fetchCommandes(){
      try{
        const res = await fetch(DATA_URL);
        const data = await res.json(); // lignes brutes
        const container = document.getElementById("commandeTable");
        container.innerHTML = "";

        const groups = groupRows(data);
        LAST_GROUPS = groups;

        const toShow = SHOW_VALIDATED ? groups : groups.filter(g => !g.allValidated);

        if(!toShow.length){
          container.innerHTML = "<p>Aucune commande √† afficher ‚úÖ</p>";
          return;
        }
        toShow.forEach(renderCommandeCard);
      }catch(err){
        console.error("Erreur fetchCommandes :", err);
        alert("Erreur lors du chargement des commandes.");
      }
    }

    // Toolbar actions
    document.getElementById('btnRefresh').onclick = fetchCommandes;
    document.getElementById('btnToggleValidated').onclick = ()=>{ SHOW_VALIDATED = !SHOW_VALIDATED; fetchCommandes(); };
    document.getElementById('btnPrint').onclick = ()=> window.print();
    document.getElementById('btnValidateAll').onclick = async ()=>{
      const groups = SHOW_VALIDATED ? LAST_GROUPS : LAST_GROUPS.filter(g => !g.allValidated);
      if(!groups.length) return;
      if(!confirm(`Valider ${groups.length} commande(s) affich√©e(s) ?`)) return;
      for(const g of groups){
        await validerCommandeGroup(g.rowNumbers);
      }
    };

    document.addEventListener("DOMContentLoaded", fetchCommandes);
  </script>
</body>
</html>


