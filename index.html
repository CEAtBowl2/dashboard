<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Pok√©bowl</title>
  <style>
    body{font-family:'Segoe UI',Roboto,sans-serif;background:#fefefe;margin:0;padding:3em;color:#333}
    h1{text-align:center;color:#ff3a3a;font-size:2.5em;letter-spacing:1px;margin:0 0 .6em}
    #commandeTable{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;padding:0;list-style:none}

    /* Toolbar */
    .toolbar{
      max-width:1100px;margin:0 auto 1rem;display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center
    }
    .tb-btn{
      background:#fff;border:1px solid #eee;border-radius:999px;padding:.55rem .9rem;cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.05);font-weight:600
    }
    .tb-btn.primary{background:#10b981;color:#fff;border-color:#10b981}
    .tb-btn.warn{background:#ff3a3a;color:#fff;border-color:#ff3a3a}

    .commande-card{width:420px;background:#fff;box-shadow:0 4px 15px rgba(0,0,0,.08);border-radius:12px;padding:1.2em;font-size:.9em;border:1px solid #f0f0f0;display:flex;flex-direction:column}
    .commande-card h2{text-align:center;margin:.1em 0 .5em;font-size:1.2em;color:#ff3a3a}
    .info{margin-bottom:.5em;border-bottom:1px dashed #ddd;padding-bottom:.5em}
    .label{font-weight:700;display:inline-block;min-width:90px}
    .tiny{font-size:.85em;opacity:.75}

    .ingredient-container{width:70px;height:92px;margin:5px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fdfdfd;border-radius:10px;padding:8px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
    .ingredient-img{width:42px;height:42px;object-fit:contain;margin-bottom:6px}
    .ingredients-grid{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin:8px 0}
    .ligne-base{display:flex;align-items:center;gap:12px}

    /* Footer actions sur carte */
    .card-actions{display:flex; flex-wrap:wrap;gap:.5rem;justify-content:space-between;align-items:center;margin-top:.6rem}
    .btn{background:#10b981;color:#fff;border:none;border-radius:10px;padding:.5rem .8rem;cursor:pointer;box-shadow:0 3px 10px rgba(16,185,129,.2);font-weight:600}
    .btn.secondary{background:#fff;color:#333;border:1px solid #eee}
    .btn.warn{background:#ff3a3a}

    @media (max-width: 900px){
      body{padding:1em}
      .ingredient-container{width:60px;height:80px}
      h1{font-size:2em}
      .commande-card{width:100%}
    }
    .tiny{font-size:.85em;opacity:.75}

  </style>
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
  <h1>Tableau de commandes Pok√©bowl</h1>

  <!-- Barre d‚Äôactions -->
  <div class="toolbar">
    <button class="tb-btn" id="btnRefresh">üîÑ Rafra√Æchir</button>
    <button class="tb-btn" id="btnToggleValidated">üëÅÔ∏è Afficher commandes valid√©es</button>
    <button class="tb-btn primary" id="btnValidateAll">‚úÖ Tout valider (affich√©es)</button>
    <button class="tb-btn" id="btnPrint">üñ®Ô∏è Imprimer la liste</button>
    <button class="tb-btn" id="btnAuto">‚è±Ô∏è Auto : ON</button>
<span id="lastRefresh" class="tiny" style="align-self:center;">Derni√®re MAJ : ‚Äî</span>
  </div>

  <div id="commandeTable"></div>

<script>
const DATA_URL = "/.netlify/functions/proxy"; 
const GAS_URL  = "https://script.google.com/macros/s/AKfycbxxBRy3c-pXakbwyL6PYvloU1IlVJme0pI_bXAMUp9OV4sh0g1LACbQGdSULnnQRKs/exec";

// AJOUTE CETTE LIGNE :
const VALIDATION_URL = GAS_URL;

// --- en haut, apr√®s la d√©claration de VALIDATION_URL ---
let META = { colValidIdx: null, colPayeeIdx: null };
const FALLBACK_META = { colValidIdx: 19, colPayeeIdx: 20 }; // 0-based: Valid√©e=20e, Pay√©e=21e

async function loadMeta() {
  const res = await fetch(`${VALIDATION_URL}?action=meta`);
  try {
    const json = await res.json();
    if (json && typeof json.colValidIdx === 'number' && typeof json.colPayeeIdx === 'number') {
      META = { colValidIdx: json.colValidIdx, colPayeeIdx: json.colPayeeIdx };
      return;
    }
  } catch(_) {}
  META = { ...FALLBACK_META };
}


async function ensureMeta() {
  if (META.colValidIdx == null || META.colPayeeIdx == null) {
    await loadMeta();
  }
  // si toujours pas bon ‚Üí applique le fallback
  if (META.colValidIdx == null || META.colValidIdx < 0) META.colValidIdx = FALLBACK_META.colValidIdx;
  if (META.colPayeeIdx == null || META.colPayeeIdx < 0) META.colPayeeIdx = FALLBACK_META.colPayeeIdx;
}

  // √©criture fiable par INDEX (0-based) dans la sheet
  // === REMPLACER setCell PAR CECI ===
  async function setCell(row, colIdx0, value) {
    await ensureMeta();
    // on passe par le proxy Netlify, pas d'appel direct √† Google
    const proxyUrl = `${DATA_URL}?proxy=set&row=${row}&col=${colIdx0}&value=${encodeURIComponent(value)}`;
    const r = await fetch(proxyUrl, { method: 'POST' });
    const t = await r.text();
    if (t.trim().toLowerCase() !== 'ok') {
      throw new Error('set failed: ' + t);
    }
  }



// bascules ‚ÄúValid√©e‚Äù et ‚ÄúPay√©e‚Äù (pour UNE ligne)
async function toggleValidee(row, currentlyValidated) {
  await ensureMeta();
  await setCell(row, META.colValidIdx, currentlyValidated ? '' : 'V');
}
async function togglePayee(row, currentlyPaid) {
  await ensureMeta();
  await setCell(row, META.colPayeeIdx, currentlyPaid ? '' : 'V');
}

// --- Helper: r√©cup√®re toujours un TABLEAU depuis DATA_URL ---
async function fetchRows() {
  const res = await fetch(DATA_URL);

  // essaie de lire en JSON
  let payload;
  try {
    payload = await res.json();
  } catch {
    // certains proxies renvoient du texte JSON (double encodage)
    const txt = await res.text();
    try { payload = JSON.parse(txt); }
    catch {
      console.error('R√©ponse non-JSON de DATA_URL:', txt);
      throw new Error('DATA_URL n‚Äôa pas renvoy√© du JSON lisible');
    }
  }

  // si double-encod√© : payload = '{"..."}'
  if (typeof payload === 'string') {
    try { payload = JSON.parse(payload); } catch {}
  }

  // normalise en tableau (g√®re {data: [...]}, {rows: [...]}, ou tableau direct)
  if (Array.isArray(payload)) return payload;
  if (payload && Array.isArray(payload.data)) return payload.data;
  if (payload && Array.isArray(payload.rows)) return payload.rows;

  console.error('Payload re√ßu depuis DATA_URL =', payload);
  throw new Error('Le proxy ne renvoie pas un tableau de lignes');
}

  // State
  let SHOW_VALIDATED = false; // false = "en cours" ; true = "valid√©es"
  let LAST_GROUPS = [];

  /** ---------- Utils format / images ---------- **/
  const isValidated = v => (String(v || '').trim().toLowerCase() === 'v');
 const isPaid = v => (String(v || '').trim().toLowerCase() === 'v'); // on met "V" dans la sheet


  function deaccent(str='') {
    return String(str).normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
  }
  function slugify(str='') {
    return deaccent(str).replace(/[^a-z0-9]+/g, ' ').trim().replace(/\s+/g, '');
  }
  function formatHoraire(h) {
    if (!h) return "";
    if (/^\d{1,2}:\d{2}$/.test(h)) return h;
    const d = new Date(h);
    if (!isNaN(d)) return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    return h;
  }

  const IMG_ALIASES = {
    'riz':'riz.png','riz noir':'riznoir.png','duo riz':'duoderiz.png','salade':'salade.png','pates':'pates.png',
    'saumon':'saumon.png','poulet':'poulet.png','oeufs':'oeufs.png','tofu':'tofu.png','thon':'thon.png',
    'avocat':'avocat.png','betterave':'betterave.png','carotte':'carotte.png','champignon':'champignon.png',
    'choux rouge':'chouxrouge.png','concombre':'concombre.png','edamame':'edamame.png','feta':'feta.png',
    'grenade':'grenade.png','mais':'mais.png','mangue':'mangue.png','mozzarella':'mozzarella.png',
    'oignon rouge':'oignonrouge.png','poivrons':'poivrons.png','radis':'radis.png','tomates':'tomates.png','wakame':'wakame.png',
    'soja sucree':'soja_sucr√©e.png','soja salee':'soja_sal√©e.png','cesar':'c√©sar.png','moutarde miel':'moutarde_miel.png',
    'curry mangue':'curry_mango.png','mayo epicee':'mayo_epic√©e.png','passion':'passion.png','balsamique':'balsamique.png',
    'sesame':'s√©same.png','pavot':'pavot.png','cacahuete':'cacahu√®te.png','croutons':'croutons.png',
    'coriandre':'coriandre.png','coriandre fraiche':'coriandre.png','oignons frits':'oignons_frits.png',
    'coca-cola':'coca.png','sprite':'sprite.png','ice tea':'icetea.png','oasis':'oasis.png','orangina':'o.png','z√©ro':'z√©ro.png','cherry':'cherry.png','fanta':'fanta.png',
    'cookie':'cookie.png','cookie chocolat':'cookie.png','cookie framboise':'cookief.png','cookie mangue':'cookiem.png',
    'smoothie':'smoothie.png','smoothie kiwi':'smoothiekiwi.png','smoothie mangue':'smoothiemangue.png','smoothie fruits rouges':'smoothierouge.png',
    'smoothie bowl kiwi':'smoothiekiwi.png','smoothie bowl mangue':'smoothiemangue.png','smoothie bowl fruits rouges':'smoothierouge.png',
    'jus concombre':'jusconcombre.png','jus pasteque':'juspasteque.png','jus carotte':'juscarotte.png','bubble tea' :'bbt.png'
  };

  function imgFromLabel(labelRaw='') {
    const label = (labelRaw || '').trim();
    if (!label) return './images/placeholder.png';
    const normalized = deaccent(label);

    if (IMG_ALIASES[normalized]) return `./images/${IMG_ALIASES[normalized]}`;

    if (normalized.startsWith('smoothie bowl')) {
      const flavor = normalized.replace('smoothie bowl','').trim();
      const base = `smoothie ${flavor}`;
      if (IMG_ALIASES[base]) return `./images/${IMG_ALIASES[base]}`;
    }
    const slug = slugify(label);
    return `./images/${slug}.png`;
  }

  /** ---------- Grouping par commande ---------- **/
  function groupKey(row){
    return [row["Horodatage"], row["Nom"], row["T√©l√©phone"]].join("||");
  }

 function groupRows(rows = []) {
  if (!Array.isArray(rows)) {
    console.error('groupRows: rows doit √™tre un tableau, re√ßu =', rows);
    return [];
  }
  const groups = new Map();
  rows.forEach((row, i) => {
    const key = groupKey(row);
    const rowNumber = i + 2; // ent√™tes ligne 1 => +2
    if(!groups.has(key)){
      groups.set(key, { meta: row, rows: [], rowNumbers: [], allValidated: true, allPaid: true });
    }
    const g = groups.get(key);
    g.rows.push(row);
    g.rowNumbers.push(rowNumber);
    if (!isValidated(row["Valid√©e"])) g.allValidated = false;
    if (!isPaid(row["Pay√©e"]))       g.allPaid = false;
  });
  return Array.from(groups.values());
}


  /** ---------- UI blocks ---------- **/
  function ingredientBlock(label){
    if(!label) return '';
    const src = imgFromLabel(label);
    return `
      <div class="ingredient-container">
        <img class="ingredient-img" src="${src}" alt="${label}">
        <div style="font-size:.7em">${label}</div>
      </div>
    `;
  }

  function renderPokeOrMenu(row){
    const titre = row["Type"] === 'menu'
      ? `Menu Pok√© ${row["Taille"] || ''} + Smoothie`
      : `Pok√© ${row["Taille"] || ''}`;

    const ingredients = (row["Ingr√©dients"] || "").split(",").map(s=>s.trim()).filter(Boolean);
    const toppings    = (row["Toppings"] || "").split(",").map(s=>s.trim()).filter(Boolean);
    const proteines   = (row["Prot√©ines"] || "").split(",").map(s=>s.trim()).filter(Boolean);

    const qty = row["Quantit√©"] || 1;
    const prix = row["Prix"] ? `${row["Prix"]} ‚Ç¨` : '‚Äî';
    const sousTotal = row["Sous-total"] ? `${row["Sous-total"]} ‚Ç¨` : '‚Äî';

    return `
      <div class="info">
        <div style="font-weight:700;margin-bottom:.3em;">${titre}</div>

        <div class="tiny">Type: <b>${row["Type"]}</b> ‚Ä¢ Article: <b>${row["Article"]||titre}</b> ‚Ä¢ Qt√©: <b>${qty}</b> ‚Ä¢ PU: <b>${prix}</b> ‚Ä¢ Sous-total: <b>${sousTotal}</b></div>

        <div class="ligne-base" style="margin-top:.35em">
          <span class="label">üßæ Base :</span>
          ${row["Base"] ? ingredientBlock(row["Base"]) : '‚Äî'}
        </div>

        <div class="label" style="margin-top:.4em">ü•ó Ingr√©dients :</div>
        <div class="ingredients-grid">
          ${ingredients.length ? ingredients.map(ingredientBlock).join('') : '‚Äî'}
        </div>

        <div class="ligne-base">
          <span class="label">üçó Prot√©ine(s) :</span>
          ${proteines.length ? proteines.map(ingredientBlock).join('') : '‚Äî'}
        </div>

        <div class="ligne-base">
          <span class="label">ü•¢ Sauce :</span>
          ${row["Sauce"] ? ingredientBlock(row["Sauce"]) : '‚Äî'}
        </div>

        <div class="label" style="margin-top:.4em">üå± Toppings :</div>
        <div class="ingredients-grid">
          ${toppings.length ? toppings.map(ingredientBlock).join('') : '‚Äî'}
        </div>

        ${row["Type"] === 'menu' && row["Smoothie"]
          ? `<div class="ligne-base"><span class="label">ü•£ Smoothie :</span> ${ingredientBlock(row["Smoothie"])}</div>`
          : ''}
      </div>
    `;
  }

  function renderSimpleItem(row){
    const article = row["Article"] || row["Type"] || "Article";
    const qty = row["Quantit√©"] || 1;
    const sousTotal = row["Sous-total"] ? `${row["Sous-total"]} ‚Ç¨` : '‚Äî';
    const src = imgFromLabel(article);
    return `
      <div class="info ligne-base">
        <div class="ingredient-container">
          <img class="ingredient-img" src="${src}" alt="${article}">
          <div style="font-size:.7em">${article}</div>
        </div>
        <div style="margin-left:8px;">
          Qt√©: ${qty} <br>
          <span style="opacity:.8">Sous-total : ${sousTotal}</span>
        </div>
      </div>
    `;
  }

  /** ---------- Actions serveur ---------- **/
  async function callRowAction(action, rowNumbers){
    const calls = rowNumbers.map(rn =>
      fetch(`${VALIDATION_URL}?action=${action}&row=${rn}`).then(r=>r.text())
    );
    const results = await Promise.all(calls);
    return results.every(t => String(t).trim().toLowerCase() === 'ok');
  }
  async function validerCommandeGroup(rowNumbers, currentlyValidated){
  for (const rn of rowNumbers) {
    await toggleValidee(rn, !!currentlyValidated);
  }
  return true;
}
async function unvaliderCommandeGroup(rowNumbers){
  // ‚ÄúcurrentlyValidated = true‚Äù pour enlever le V
  for (const rn of rowNumbers) {
    await toggleValidee(rn, true);
  }
  return true;
}
async function payerCommandeGroup(rowNumbers, currentlyPaid){
  for (const rn of rowNumbers) {
    await togglePayee(rn, !!currentlyPaid);
  }
  return true;
}


  /** ---------- Carte commande ---------- **/
  function telHref(phone){
    const digits = String(phone||'').replace(/[^\d+]/g,'');
    return digits ? `tel:${digits}` : null;
  }

  function renderCommandeCard(group){
    const c = group.meta;
    const container = document.getElementById("commandeTable");

    const card = document.createElement("div");
    card.className = "commande-card";

    // Titre (Nom + ID court)
    const h2 = document.createElement("h2");
    const t  = new Date(c["Horodatage"]);
    const id = isNaN(t.getTime())
      ? "#" + Math.floor(100000 + Math.random()*900000)
      : `#${String(t.getHours()).padStart(2,'0')}${String(t.getMinutes()).padStart(2,'0')}`;
    h2.textContent = `${c["Nom"] || ""} ${id}`;
    card.appendChild(h2);

    // Cr√©√©e / Locker / Tel / Horaire
    const dt = document.createElement("div");
    dt.className = "info tiny";
    dt.innerHTML = `<span class="label">üóìÔ∏è Cr√©√©e :</span> ${c["Horodatage"] || "‚Äî"}`;
    card.appendChild(dt);

    const locker = document.createElement("div");
    locker.className = "info";
    locker.innerHTML = `<span class="label">üì¶ Locker :</span> ${c["Locker"] || "‚Äì"}`;
    card.appendChild(locker);

    const tel = document.createElement("div");
    tel.className = "info";
    tel.innerHTML = `<span class="label">üìû T√©l√©phone :</span> ${c["T√©l√©phone"] || ""}`;
    card.appendChild(tel);

    const horaire = document.createElement("div");
    horaire.className = "info";
    horaire.innerHTML = `<span class="label">üïí Horaire :</span> <strong>${formatHoraire(c["Horaire"])}</strong>`;
    card.appendChild(horaire);

    // Items
    const pokeRows   = group.rows.filter(r => (r["Type"] === 'poke' || r["Type"] === 'menu'));
    const simpleRows = group.rows.filter(r => !(r["Type"] === 'poke' || r["Type"] === 'menu'));

    pokeRows.forEach(r => {
      const block = document.createElement("div");
      block.innerHTML = renderPokeOrMenu(r);
      card.appendChild(block);
    });

    if(simpleRows.length){
      const lab = document.createElement("div");
      lab.className = "label";
      lab.textContent = "üßÅ Articles compl√©mentaires :";
      card.appendChild(lab);

      simpleRows.forEach(r => {
        const block = document.createElement("div");
        block.innerHTML = renderSimpleItem(r);
        card.appendChild(block);
      });
    }

    // Remarques
    if (c["Commentaires"]) {
      const rem = document.createElement("div");
      rem.className = "info";
      rem.innerHTML = `<span class="label">üìù Remarques :</span> ${c["Commentaires"]}`;
      card.appendChild(rem);
    }

    // Footer : total + boutons
    const footer = document.createElement("div");
    footer.className = "card-actions";

    const totalDiv = document.createElement("div");
    totalDiv.innerHTML = `<span class="label">üí∂ Total :</span> <b>${c["Total"] || "‚Äî"}</b>`;
    footer.appendChild(totalDiv);

    const btns = document.createElement("div");
    btns.style.display = "flex"; btns.style.gap = ".4rem"; btns.style.flexWrap = "wrap";

    // Appeler
    const callHref = telHref(c["T√©l√©phone"]);
    const bCall = document.createElement("button");
    bCall.className = "btn secondary";
    bCall.textContent = "üì≤ Appeler";
    if(callHref){ bCall.onclick = ()=> window.location.href = callHref; } else { bCall.disabled = true; }
    btns.appendChild(bCall);

    // Imprimer
    const bPrint = document.createElement("button");
    bPrint.className = "btn secondary";
    bPrint.textContent = "üñ®Ô∏è Imprimer";
    bPrint.onclick = ()=> {
      const w = window.open('', '_blank');
      w.document.write(`<html><head><title>${c["Nom"]||"Commande"}</title></head><body>${card.outerHTML}</body></html>`);
      w.document.close(); w.focus(); w.print(); w.close();
    };
    btns.appendChild(bPrint);

    // Boutons selon la vue
    if (!SHOW_VALIDATED) {
      // Vue "En cours" -> bouton pour VALIDER
      const bOk = document.createElement("button");
bOk.className = "btn warn";
bOk.textContent = "Commande pr√™te";
bOk.onclick = async ()=> {
  try {
    await ensureMeta(); // <‚Äî
    await validerCommandeGroup(group.rowNumbers, /*currentlyValidated=*/false);
    fetchCommandes();
  } catch(e) {
    alert("Une ou plusieurs lignes n'ont pas pu √™tre valid√©es.");
    console.error(e);
  }
};

btns.appendChild(bOk);

    } else {
      // Vue "Valid√©es" -> Revenir en cours + Pay√©e
      const bBack = document.createElement("button");
bBack.className = "btn";
bBack.textContent = "‚Ü©Ô∏è Revenir en cours";
bBack.onclick = async ()=>{
  try {
    await ensureMeta(); // <‚Äî
    await unvaliderCommandeGroup(group.rowNumbers);
    fetchCommandes();
  } catch(e) {
    alert("Impossible d'annuler la validation sur une ou plusieurs lignes.");
    console.error(e);
  }
};
btns.appendChild(bBack);


      const alreadyPaid = isPaid(c["Pay√©e"]);
const bPaid = document.createElement("button");
bPaid.className = "btn warn";
bPaid.textContent = alreadyPaid ? "üí∏ D√©pay√©e" : "üí∂ Pay√©e";
bPaid.onclick = async ()=>{
  try {
    await ensureMeta(); // <‚Äî
    await payerCommandeGroup(group.rowNumbers, /*currentlyPaid=*/alreadyPaid);
    fetchCommandes();
  } catch(e) {
    alert("Impossible de basculer Pay√©e.");
    console.error(e);
  }
};

btns.appendChild(bPaid);
}

    footer.appendChild(btns);
    card.appendChild(footer);

    container.appendChild(card);
  }

  /** ---------- Fetch + rendu ---------- **/
  async function fetchCommandes(){
    try{
      const rows = await fetchRows(); // ‚Üê normalis√© en tableau
const container = document.getElementById("commandeTable");
container.innerHTML = "";

const groups = groupRows(rows);

      LAST_GROUPS = groups;

      // 1) On masque TOUTES les "pay√©es"
      let visible = groups.filter(g => !g.allPaid);

      // 2) Filtre par vue :
      //    - SHOW_VALIDATED = false -> seulement NON valid√©es (en cours)
      //    - SHOW_VALIDATED = true  -> seulement TOUTES valid√©es
      visible = visible.filter(g => SHOW_VALIDATED ? g.allValidated : !g.allValidated);

      if(!visible.length){
        container.innerHTML = SHOW_VALIDATED
          ? "<p>Aucune commande valid√©e √† afficher ‚úÖ</p>"
          : "<p>Aucune commande en cours √† afficher ‚úÖ</p>";
        return;
      }
      visible.forEach(renderCommandeCard);
    }catch(err){
      console.error("Erreur fetchCommandes :", err);
      alert("Erreur lors du chargement des commandes.");
    }
  }
// ===== Auto-refresh =====
let AUTO_REFRESH = true;         // √©tat ON/OFF
let POLL_MS = 8000;              // intervalle standard
let timerId = null;              // id du setInterval courant
let backoffMs = null;            // backoff temporaire apr√®s erreur
const LAST_OK = { ts: null };    // garde en m√©moire la derni√®re MAJ r√©ussie

function formatTimeFR(d = new Date()){
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}

function setLastRefresh(ts){
  const el = document.getElementById('lastRefresh');
  if (!el) return;
  el.textContent = ts ? `Derni√®re MAJ : ${formatTimeFR(new Date(ts))}` : 'Derni√®re MAJ : ‚Äî';
}

async function runRefreshOnce(){
  // si l‚Äôonglet est cach√©, on ne poll pas (√©conomie)
  if (document.hidden) return;
  try{
    await fetchCommandes();
    LAST_OK.ts = Date.now();
    setLastRefresh(LAST_OK.ts);
    // reset du backoff apr√®s succ√®s
    backoffMs = null;
    scheduleAutoRefresh(); // s‚Äôassure qu‚Äôon est bien sur l‚Äôintervalle nominal
  }catch(e){
    console.error('Auto-refresh: erreur fetchCommandes', e);
    // passe en backoff exponentiel l√©ger
    backoffMs = Math.min(60000, (backoffMs ? backoffMs * 2 : 10000)); // 10s ‚Üí 20s ‚Üí 40s ‚Üí 60s (max)
    scheduleAutoRefresh();
  }
}

function scheduleAutoRefresh(){
  clearInterval(timerId);
  if (!AUTO_REFRESH) return;
  const interval = backoffMs || POLL_MS;
  timerId = setInterval(runRefreshOnce, interval);
}

function toggleAutoRefresh(force = null){
  AUTO_REFRESH = (force === null ? !AUTO_REFRESH : !!force);
  const btn = document.getElementById('btnAuto');
  if (btn) btn.textContent = `‚è±Ô∏è Auto : ${AUTO_REFRESH ? 'ON' : 'OFF'}`;
  if (AUTO_REFRESH){
    runRefreshOnce();     // rafra√Æchit tout de suite
    scheduleAutoRefresh();// puis planifie
  }else{
    clearInterval(timerId);
    timerId = null;
  }
}

// Rafra√Æchit imm√©diatement quand l‚Äôonglet redevient visible
document.addEventListener('visibilitychange', ()=>{
  if (!document.hidden && AUTO_REFRESH) runRefreshOnce();
});

  // Toolbar
  document.getElementById('btnRefresh').onclick = fetchCommandes;
  document.getElementById('btnToggleValidated').onclick = ()=>{
    SHOW_VALIDATED = !SHOW_VALIDATED;
    document.getElementById('btnToggleValidated').textContent =
      SHOW_VALIDATED ? "üëÅÔ∏è Afficher commandes EN COURS" : "üëÅÔ∏è Afficher commandes VALID√âES";
    fetchCommandes();
  };
  document.getElementById('btnPrint').onclick = ()=> window.print();
  document.getElementById('btnAuto').onclick = ()=> toggleAutoRefresh();
document.getElementById('btnValidateAll').onclick = async ()=>{
  if (SHOW_VALIDATED) { fetchCommandes(); return; }
  await ensureMeta(); // <‚Äî ajoute cette ligne
  const containerGroups = LAST_GROUPS
    .filter(g => !g.allPaid)
    .filter(g => !g.allValidated);
  if(!containerGroups.length) return;
  if(!confirm(`Valider ${containerGroups.length} commande(s) affich√©e(s) ?`)) return;
  for(const g of containerGroups){
    await validerCommandeGroup(g.rowNumbers);
  }
  fetchCommandes();
};

document.addEventListener("DOMContentLoaded", async ()=>{
  document.getElementById('btnToggleValidated').textContent = "üëÅÔ∏è Afficher commandes VALID√âES";
  try { await ensureMeta(); } catch(e){ console.error('META load error', e); }
  setLastRefresh(null);
  toggleAutoRefresh(true); // ON au d√©marrage + 1er fetch imm√©diat
});



</script>


</body>
</html>



























