<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Pokébowl</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fff8f5;
      padding: 2em;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #ff3a3a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2em;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 1em;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background-color: #ffe5e0;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 0.5em 1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .ingredient-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background-color: #ffffff;
  border-radius: 10px;
  padding: 10px;
  margin: 5px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  width: 80px;
  height: 100px;
  box-sizing: border-box;
}

.ingredient-img {
  width: 40px;
  height: 40px;
  object-fit: contain;
  margin-bottom: 6px;
}


    
  </style>
</head>
<body>
  <h1>Dashboard Commandes</h1>
  <table id="commandeTable">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Téléphone</th>
        <th>Taille</th>
        <th>Base</th>
        <th>Ingrédients</th>
        <th>Protéines</th>
        <th>Remarques</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const DATA_URL = "/.netlify/functions/proxy";
    const VALIDATION_URL = "https://script.google.com/macros/s/AKfycbzO1YE54lzfF8iZmndAbAxrZILs3V5zkGJt11_dkkJK6ZLd8uAAfpUG0hjMTLXVuIw/exec";

    function fetchCommandes() {
      fetch(DATA_URL)
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector("#commandeTable tbody");
          tbody.innerHTML = "";

          data.forEach((commande, index) => {
            if ((commande["Validée"] || "").toLowerCase() !== "v") {
              const tr = document.createElement("tr");

              // Nom
              const tdNom = document.createElement("td");
              tdNom.textContent = commande["Nom"] || "";
              tr.appendChild(tdNom);

              // Téléphone
              const tdTel = document.createElement("td");
              tdTel.textContent = commande["Téléphone"] || "";
              tr.appendChild(tdTel);

              // Taille
              const tdTaille = document.createElement("td");
              tdTaille.textContent = commande["Taille"] || "";
              tr.appendChild(tdTaille);

              // Base
              const tdBase = document.createElement("td");
const base = commande["Base"] || "";
if (base) {
  const baseContainer = document.createElement("div");
  baseContainer.className = "ingredient-container"; // même style que les ingrédients

  const baseImg = document.createElement("img");
  baseImg.src = `./images/${base.toLowerCase().replace(/ /g, "_")}.png`;
  baseImg.alt = base;
  baseImg.className = "ingredient-img";

  const baseLabel = document.createElement("div");
  baseLabel.textContent = base;
  baseLabel.style.fontSize = "0.8em";

  baseContainer.appendChild(baseImg);
  baseContainer.appendChild(baseLabel);
  tdBase.appendChild(baseContainer);
}
tr.appendChild(tdBase);

              // Ingrédients
              const tdIngr = document.createElement("td");
              const ingredients = (commande["Ingrédients"] || "").split(",").map(i => i.trim());
              ingredients.forEach(ingredient => {
                const container = document.createElement("div");
                container.className = "ingredient-container";

                const img = document.createElement("img");
                img.src = `./images/${ingredient.toLowerCase().replace(/ /g, "_")}.png`;
                img.alt = ingredient;
                img.className = "ingredient-img";

                const label = document.createElement("div");
                label.textContent = ingredient;
                label.style.fontSize = "0.8em";

                container.appendChild(img);
                container.appendChild(label);
                tdIngr.appendChild(container);
              });
              tr.appendChild(tdIngr);

              // Protéines (avec image + nom)
const tdProt = document.createElement("td");
const prot = commande["Protéines"] || "";
if (prot) {
  const protContainer = document.createElement("div");
  protContainer.className = "ingredient-container";

  const protImg = document.createElement("img");
  protImg.src = `./images/${prot.toLowerCase().replace(/ /g, "_")}.png`;
  protImg.alt = prot;
  protImg.className = "ingredient-img";

  const protLabel = document.createElement("div");
  protLabel.textContent = prot;
  protLabel.style.fontSize = "0.8em";

  protContainer.appendChild(protImg);
  protContainer.appendChild(protLabel);
  tdProt.appendChild(protContainer);
}
tr.appendChild(tdProt);



              // Remarques
              const tdRem = document.createElement("td");
              tdRem.textContent = commande["Remarques"] || "";
              tr.appendChild(tdRem);

              // Bouton
              const tdAction = document.createElement("td");
              const btn = document.createElement("button");
              btn.textContent = "Commande prête";
              btn.onclick = () => validerCommande(index + 2);
              tdAction.appendChild(btn);
              tr.appendChild(tdAction);

              tbody.appendChild(tr);
            }
          });
        })
        .catch(err => {
          console.error("Erreur fetchCommandes :", err);
          alert("Erreur lors du chargement des commandes.");
        });
    }

    function validerCommande(rowNumber) {
      const url = `${VALIDATION_URL}?action=valider&row=${rowNumber}`;
      fetch(url)
        .then(res => res.text())
        .then(text => {
          if (text.trim().toLowerCase() === "ok") {
            alert("Commande validée !");
            setTimeout(fetchCommandes, 1000);
          } else {
            alert("Erreur côté script : " + text);
          }
        })
        .catch(error => {
          console.error("Erreur réseau :", error);
          alert("Erreur réseau lors de la validation.");
        });
    }

    document.addEventListener("DOMContentLoaded", fetchCommandes);
  </script>
</body>
</html>
