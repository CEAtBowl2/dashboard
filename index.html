<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Pok√©bowl</title>
  <style>
    body{font-family:'Segoe UI',Roboto,sans-serif;background:#fefefe;margin:0;padding:3em;color:#333}
    h1{text-align:center;color:#ff3a3a;font-size:2.5em;letter-spacing:1px;margin:0 0 .6em}
    #commandeTable{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;padding:0;list-style:none}

    /* Toolbar */
    .toolbar{
      max-width:1100px;margin:0 auto 1rem;display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center
    }
    .tb-btn{
      background:#fff;border:1px solid #eee;border-radius:999px;padding:.55rem .9rem;cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.05);font-weight:600
    }
    .tb-btn.primary{background:#10b981;color:#fff;border-color:#10b981}
    .tb-btn.warn{background:#ff3a3a;color:#fff;border-color:#ff3a3a}

    .commande-card{width:320px;background:#fff;box-shadow:0 4px 15px rgba(0,0,0,.08);border-radius:12px;padding:1.2em;font-size:.9em;border:1px solid #f0f0f0;display:flex;flex-direction:column}
    .commande-card h2{text-align:center;margin:.1em 0 .5em;font-size:1.2em;color:#ff3a3a}
    .info{margin-bottom:.5em;border-bottom:1px dashed #ddd;padding-bottom:.5em}
    .label{font-weight:700;display:inline-block;min-width:90px}
    .tiny{font-size:.85em;opacity:.75}

    .ingredient-container{width:70px;height:92px;margin:5px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fdfdfd;border-radius:10px;padding:8px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
    .ingredient-img{width:42px;height:42px;object-fit:contain;margin-bottom:6px}
    .ingredients-grid{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin:8px 0}
    .ligne-base{display:flex;align-items:center;gap:12px}

    /* Footer actions sur carte */
    .card-actions{display:flex;gap:.5rem;justify-content:space-between;align-items:center;margin-top:.6rem}
    .btn{background:#10b981;color:#fff;border:none;border-radius:10px;padding:.5rem .8rem;cursor:pointer;box-shadow:0 3px 10px rgba(16,185,129,.2);font-weight:600}
    .btn.secondary{background:#fff;color:#333;border:1px solid #eee}
    .btn.warn{background:#ff3a3a}

    @media (max-width: 900px){
      body{padding:1em}
      .ingredient-container{width:60px;height:80px}
      h1{font-size:2em}
      .commande-card{width:100%}
    }
  </style>
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
  <h1>Tableau de commandes Pok√©bowl</h1>

  <!-- Barre d‚Äôactions -->
  <div class="toolbar">
    <button class="tb-btn" id="btnRefresh">üîÑ Rafra√Æchir</button>
    <button class="tb-btn" id="btnToggleValidated">üëÅÔ∏è Afficher commandes valid√©es</button>
    <button class="tb-btn primary" id="btnValidateAll">‚úÖ Tout valider (affich√©es)</button>
    <button class="tb-btn" id="btnPrint">üñ®Ô∏è Imprimer la liste</button>
  </div>

  <div id="commandeTable"></div>

  <script>
    // URLs
    const DATA_URL = "/.netlify/functions/proxy"; 
    const VALIDATION_URL = "https://script.google.com/macros/s/AKfycbzO1YE54lzfF8iZmndAbAxrZILs3V5zkGJt11_dkkJK6ZLd8uAAfpUG0hjMTLXVuIw/exec";

    // State
    let SHOW_VALIDATED = false;
    let LAST_GROUPS = [];

    /** ---------- Utils de format & mapping images ---------- **/
    function deaccent(str='') {
      return String(str).normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function slugify(str='') {
      return deaccent(str).replace(/[^a-z0-9]+/g, ' ').trim().replace(/\s+/g, '');
    }
    function slugUnderscore(str='') {
      return deaccent(str).replace(/[^a-z0-9]+/g, ' ').trim().replace(/\s+/g, '_');
    }
    function formatHoraire(h) {
      if (!h) return "";
      if (/^\d{1,2}:\d{2}$/.test(h)) return h;
      const d = new Date(h);
      if (!isNaN(d)) {
        return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      }
      return h;
    }
    const IMG_ALIASES = {
      'riz': 'riz.png','riz noir': 'riznoir.png','duo de riz': 'duoderiz.png','salade': 'salade.png','pates': 'pates.png',
      'saumon': 'saumon.png','poulet': 'poulet.png','oeufs': 'oeufs.png','tofu': 'tofu.png','thon': 'thon.png',
      'avocat': 'avocat.png','betterave': 'betterave.png','carotte': 'carotte.png','champignon': 'champignon.png',
      'choux rouge': 'chouxrouge.png','concombre': 'concombre.png','edamame': 'edamame.png','feta': 'feta.png',
      'grenade': 'grenade.png','mais': 'mais.png','mangue': 'mangue.png','mozzarella': 'mozzarella.png',
      'oignon rouge': 'oignonrouge.png','poivrons': 'poivrons.png','radis': 'radis.png','tomates': 'tomates.png',
      'wakame': 'wakame.png','soja sucree': 'soja.png','soja salee': 'soja.png','cesar': 'c√©sar.png',
      'moutarde miel': 'miel_moutarde.png','curry mangue': 'curry_mango.png','mayo epicee': 'mayo_epicee.png',
      'passion': 'passion.png','balsamique': 'balsamique.png','sesame': 's√©same.png','pavot': 'pavot.png',
      'cacahuete': 'cacahu√®tes.png','croutons': 'croutons.png','coriandre': 'coriandre.png',
      'coriandre fraiche': 'coriandre.png','oignons frits': 'oignons_frits.png','coca': 'coca.png',
      'sprite': 'sprite.png','ice tea': 'icetea.png','oasis': 'oasis.png','orangina': 'o.png','cookie': 'cookie.png',
      'cookie chocolat': 'cookie.png','cookie framboise': 'cookief.png','cookie mangue': 'cookiem.png',
      'smoothie': 'smoothie.png','smoothie kiwi': 'smoothiekiwi.png','smoothie mangue': 'smoothiemangue.png',
      'smoothie fruits rouges': 'smoothierouge.png','smoothie bowl kiwi': 'smoothiekiwi.png',
      'smoothie bowl mangue': 'smoothiemangue.png','smoothie bowl fruits rouges': 'smoothierouge.png',
      'jus concombre': 'jusconcombre.png','jus pasteque': 'juspasteque.png','jus carotte': 'juscarotte.png'
    };
    function imgFromLabel(labelRaw='') {
      const label = (labelRaw || '').trim();
      if (!label) return './images/placeholder.png';
      const normalized = deaccent(label);
      if (IMG_ALIASES[normalized]) return `./images/${IMG_ALIASES[normalized]}`;
      if (normalized.startsWith('smoothie bowl')) {
        const flavor = normalized.replace('smoothie bowl','').trim();
        const base = `smoothie ${flavor}`;
        if (IMG_ALIASES[base]) return `./images/${IMG_ALIASES[base]}`;
      }
      if (IMG_ALIASES[normalized]) return `./images/${IMG_ALIASES[normalized]}`;
      const slug = slugify(label);
      return `./images/${slug}.png`;
    }

    const isValidated = v => (String(v || '').trim().toLowerCase() === 'v');

    function groupKey(row){ return [row["Horodatage"], row["Nom"], row["T√©l√©phone"]].join("||"); }
    function groupRows(rows){
      const groups = new Map();
      rows.forEach((row, i) => {
        const key = groupKey(row);
        const rowNumber = i + 2;
        if(!groups.has(key)) groups.set(key,{ meta: row, rows: [], rowNumbers: [], allValidated: true });
        const g = groups.get(key);
        g.rows.push(row); g.rowNumbers.push(rowNumber);
        if(!isValidated(row["Valid√©e"])) g.allValidated = false;
      });
      return Array.from(groups.values());
    }

    function ingredientBlock(label){
      if(!label) return '';
      const src = imgFromLabel(label);
      return `<div class="ingredient-container">
        <img class="ingredient-img" src="${src}" alt="${label}">
        <div style="font-size:.7em">${label}</div>
      </div>`;
    }

    function renderSimpleItem(row){
      const article = row["Article"] || row["Type"] || "Article";
      const qty = row["Quantit√©"] || 1;
      const sousTotal = row["Sous-total"] ? `${row["Sous-total"]} ‚Ç¨` : '‚Äî';
      const src = imgFromLabel(article);
      return `<div class="info ligne-base">
        <div class="ingredient-container">
          <img class="ingredient-img" src="${src}" alt="${article}">
          <div style="font-size:.7em">${article}</div>
        </div>
        <div style="margin-left:8px;">Qt√©: ${qty} <br><span style="opacity:.8">Sous-total : ${sousTotal}</span></div>
      </div>`;
    }

    /* renderPokeOrMenu, validerCommandeGroup, telHref, renderCommandeCard, fetchCommandes => inchang√©s sauf horaire */
    // ... [reprend ton code existant avec horaire.innerHTML = `<span class="label">üïí Horaire :</span> <strong>${formatHoraire(c["Horaire"])}</strong>`] ...
  </script>
</body>
</html>
